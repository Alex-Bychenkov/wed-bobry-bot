name: Cleanup Prometheus Metrics

# –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥–æ–µ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 3:00 –Ω–æ—á–∏ (MSK = 00:00 UTC)
on:
  schedule:
    - cron: '0 0 * * 0'
  # –ú–æ–∂–Ω–æ –∑–∞–ø—É—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Cleanup Prometheus metrics
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER }}
          username: ${{ secrets.LOGIN }}
          password: ${{ secrets.PASSWORD }}
          script: |
            echo "üóëÔ∏è –û—á–∏—Å—Ç–∫–∞ –º–µ—Ç—Ä–∏–∫ Prometheus..."
            
            cd /opt/monitoring
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Prometheus
            docker-compose -f docker-compose.monitoring.yml stop prometheus
            
            # –£–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
            docker volume rm monitoring_prometheus_data 2>/dev/null || true
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º Prometheus
            docker-compose -f docker-compose.monitoring.yml up -d prometheus
            
            # –ñ–¥—ë–º –∑–∞–ø—É—Å–∫–∞
            sleep 10
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Grafana –¥–ª—è –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            docker-compose -f docker-compose.monitoring.yml restart grafana
            
            echo "‚úÖ –û—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
            docker-compose -f docker-compose.monitoring.yml ps

      - name: Cleanup complete
        run: echo "‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ Prometheus –æ—á–∏—â–µ–Ω—ã"
