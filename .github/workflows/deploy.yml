name: Deploy to Server

# –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é –∏–∑ GitHub UI
on:
  workflow_dispatch:
    inputs:
      confirm:
        description: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–ø–ª–æ–π (–Ω–∞–ø–∏—à–∏—Ç–µ "deploy")'
        required: true
        default: ''
      clear_metrics:
        description: '–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ Prometheus'
        type: boolean
        default: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'deploy'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER }}
          username: ${{ secrets.LOGIN }}
          password: ${{ secrets.PASSWORD }}
          script: |
            cd /opt/wed-bobry-bot
            
            # –ü–æ–ª—É—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ Git
            git fetch origin
            git reset --hard origin/main
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã (–≤–∫–ª—é—á–∞—è "–æ—Å–∏—Ä–æ—Ç–µ–≤—à–∏–µ")
            docker-compose down --remove-orphans
            
            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª—è–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ –æ—Å—Ç–∞–ª—Å—è
            docker rm -f wed-bobry-bot 2>/dev/null || true
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
            docker-compose up -d --build
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
            if [ -d monitoring ]; then
              echo "üìä –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞..."
              # –î–∞—à–±–æ—Ä–¥—ã Grafana
              cp -r monitoring/grafana/dashboards/* /opt/monitoring/grafana/dashboards/ 2>/dev/null || true
              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Prometheus (alerts, prometheus.yml)
              cp monitoring/alerts.yml /opt/monitoring/alerts.yml 2>/dev/null || true
              cp monitoring/prometheus.yml /opt/monitoring/prometheus.yml 2>/dev/null || true
              cp monitoring/alertmanager.yml /opt/monitoring/alertmanager.yml 2>/dev/null || true
              echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞"
            fi
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ (Grafana, Prometheus) –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
            if [ -f /opt/monitoring/docker-compose.monitoring.yml ]; then
              cd /opt/monitoring
              
              # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω—É–∂–Ω–∞ –ª–∏ –æ—á–∏—Å—Ç–∫–∞ –º–µ—Ç—Ä–∏–∫
              if [ "${{ github.event.inputs.clear_metrics }}" = "true" ]; then
                echo "üóëÔ∏è –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –Ω–∞–∫–æ–ø–ª–µ–Ω–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫ Prometheus..."
                docker-compose -f docker-compose.monitoring.yml down
                docker volume rm monitoring_prometheus_data 2>/dev/null || true
                docker-compose -f docker-compose.monitoring.yml up -d
                echo "‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ –æ—á–∏—â–µ–Ω—ã, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
              else
                echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞..."
                docker-compose -f docker-compose.monitoring.yml restart grafana prometheus
                echo "‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω"
              fi
              
              cd /opt/wed-bobry-bot
            fi
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å
            echo "‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω"
            docker-compose ps
            docker-compose -f /opt/monitoring/docker-compose.monitoring.yml ps 2>/dev/null || true

      - name: Deployment complete
        run: echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª—ë–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!"
