version: '3.3'

networks:
  monitoring:
    external: true
    name: monitoring

services:
  wed-bobry-bot:
    build: .
    container_name: wed-bobry-bot
    env_file:
      - .env
    environment:
      - TZ=${TIMEZONE:-Europe/Moscow}
    volumes:
      - ./data:/app/data
    # Порт НЕ публикуем наружу — Prometheus ходит через Docker-сеть monitoring.
    # Это предотвращает блокировку metrics-сервера интернет-сканерами.
    expose:
      - "8000"
    restart: unless-stopped
    networks:
      - monitoring
    # Ограничения ресурсов (120M было мало — возможен OOM и BotDown)
    deploy:
      resources:
        limits:
          memory: 200M
        reservations:
          memory: 80M
    mem_limit: 200m
    memswap_limit: 250m
    # Healthcheck: при недоступности /metrics контейнер перезапустится
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 25s
