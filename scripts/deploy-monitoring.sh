#!/bin/bash
set -e

SERVER_IP="87.247.157.122"
SERVER_USER="root"
SERVER_PASS="${SERVER_PASS:-F65NkiCBmM}"
MONITORING_DIR="/opt/monitoring"
LOCAL_MONITORING_DIR="./monitoring"

# –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã SSH
if command -v sshpass &> /dev/null && [ -n "$SERVER_PASS" ]; then
    SSH_CMD="sshpass -p '$SERVER_PASS' ssh -o StrictHostKeyChecking=no -T"
    SCP_CMD="sshpass -p '$SERVER_PASS' scp -o StrictHostKeyChecking=no"
else
    SSH_CMD="ssh"
    SCP_CMD="scp"
fi

echo "üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä $SERVER_IP..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
if [ ! -d "$LOCAL_MONITORING_DIR" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è monitoring –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è .env —Ñ–∞–π–ª–∞ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ)
if [ ! -f "$LOCAL_MONITORING_DIR/.env" ]; then
    echo "‚ö†Ô∏è  –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω. –ë—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π."
    ENV_FILE_EXISTS=false
else
    ENV_FILE_EXISTS=true
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞..."
if ! $SSH_CMD "$SERVER_USER@$SERVER_IP" "command -v docker &> /dev/null" 2>/dev/null; then
    echo "‚ùå Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ!"
    echo "   –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞: ./scripts/deploy.sh"
    exit 1
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
$SSH_CMD "$SERVER_USER@$SERVER_IP" "mkdir -p $MONITORING_DIR" 2>/dev/null || true

# –°–æ–∑–¥–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ —Ñ–∞–π–ª–æ–≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
echo "üì¶ –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏..."
cd "$LOCAL_MONITORING_DIR"
tar --exclude='.env' --exclude='telegram-bot-data' \
    --exclude='*.db' -czf /tmp/monitoring-deploy.tar.gz .

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∞—Ä—Ö–∏–≤–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
echo "üì§ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä..."
$SCP_CMD /tmp/monitoring-deploy.tar.gz "$SERVER_USER@$SERVER_IP:/tmp/" 2>&1
rm -f /tmp/monitoring-deploy.tar.gz

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞ –æ—Ç–¥–µ–ª—å–Ω–æ (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
if [ "$ENV_FILE_EXISTS" = true ]; then
    echo "üì§ –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ .env —Ñ–∞–π–ª–∞..."
    $SCP_CMD "$LOCAL_MONITORING_DIR/.env" "$SERVER_USER@$SERVER_IP:$MONITORING_DIR/.env.new" 2>&1 || true
else
    echo "‚ö†Ô∏è  –õ–æ–∫–∞–ª—å–Ω—ã–π .env —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω, –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ"
fi

# –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
echo "üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏ –∑–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ..."
$SSH_CMD "$SERVER_USER@$SERVER_IP" << 'ENDSSH'
set -e
cd /opt/monitoring

# –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤
if [ -f /tmp/monitoring-deploy.tar.gz ]; then
    echo "üì¶ –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞..."
    tar -xzf /tmp/monitoring-deploy.tar.gz -C /opt/monitoring
    rm -f /tmp/monitoring-deploy.tar.gz
fi

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ .env —Ñ–∞–π–ª–∞ (–µ—Å–ª–∏ –Ω–æ–≤—ã–π —Ñ–∞–π–ª —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
if [ -f .env.new ]; then
    mv .env.new .env
    echo "‚úÖ –§–∞–π–ª .env –æ–±–Ω–æ–≤–ª–µ–Ω"
fi

# –°–æ–∑–¥–∞–Ω–∏–µ .env –∏–∑ –ø—Ä–∏–º–µ—Ä–∞, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
if [ ! -f .env ]; then
    if [ -f .env.example ]; then
        echo "üìã –°–æ–∑–¥–∞–Ω–∏–µ .env –∏–∑ .env.example..."
        cp .env.example .env
        echo "‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: –ù–µ –∑–∞–±—É–¥—å—Ç–µ –∑–∞–ø–æ–ª–Ω–∏—Ç—å TELEGRAM_ALERT_BOT_TOKEN –≤ —Ñ–∞–π–ª–µ .env!"
    else
        echo "‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω –∏ .env.example —Ç–∞–∫–∂–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç!"
        exit 1
    fi
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö telegram –±–æ—Ç–∞
mkdir -p telegram-bot-data

# –£–¥–∞–ª–µ–Ω–∏–µ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ macOS (–º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å –æ—à–∏–±–∫–∏ –≤ Grafana)
echo "üßπ –û—á–∏—Å—Ç–∫–∞ —Å–ª—É–∂–µ–±–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤ macOS..."
find grafana/ -name "._*" -type f -delete 2>/dev/null || true
find . -name ".DS_Store" -type f -delete 2>/dev/null || true

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞..."
docker-compose -f docker-compose.monitoring.yml down || true

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
echo "üöÄ –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞..."
docker-compose -f docker-compose.monitoring.yml up -d

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 10

# –ü–æ–∫–∞–∑ –ª–æ–≥–æ–≤
echo ""
echo "üìã –õ–æ–≥–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å—Ç—Ä–æ–∫):"
docker-compose -f docker-compose.monitoring.yml logs --tail=30

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
echo ""
echo "üìä –°—Ç–∞—Ç—É—Å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:"
docker-compose -f docker-compose.monitoring.yml ps

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤
echo ""
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–æ–≤..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Prometheus
if curl -s http://localhost:9090/-/healthy > /dev/null 2>&1; then
    echo "‚úÖ Prometheus –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 9090"
else
    echo "‚ö†Ô∏è  Prometheus –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 9090"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Grafana
if curl -s http://localhost:3000/api/health > /dev/null 2>&1; then
    echo "‚úÖ Grafana –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3000"
else
    echo "‚ö†Ô∏è  Grafana –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 3000"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Node Exporter
if curl -s http://localhost:9100/metrics > /dev/null 2>&1; then
    echo "‚úÖ Node Exporter –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 9100"
else
    echo "‚ö†Ô∏è  Node Exporter –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 9100"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Alertmanager
if curl -s http://localhost:9093/-/healthy > /dev/null 2>&1; then
    echo "‚úÖ Alertmanager –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 9093"
else
    echo "‚ö†Ô∏è  Alertmanager –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 9093"
fi

ENDSSH

echo ""
echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üìä –î–æ—Å—Ç—É–ø –∫ —Å–µ—Ä–≤–∏—Å–∞–º:"
echo "   - Prometheus: http://$SERVER_IP:9090"
echo "   - Grafana: http://$SERVER_IP:3000 (admin/admin)"
echo "   - Alertmanager: http://$SERVER_IP:9093"
echo ""
echo "–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
echo "  ssh $SERVER_USER@$SERVER_IP 'cd $MONITORING_DIR && docker-compose -f docker-compose.monitoring.yml logs -f'"
